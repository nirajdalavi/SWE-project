name: Deploy to GCP Compute Engine

on:
  push:
    branches:
      - main
    # paths:
    #   - './**'

jobs:
  deploy-gcp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (for GitHub context)
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          echo "${{ secrets.GCP_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy on GCP Compute Engine
        env:
          GIT_AUTH_TOKEN: ${{ secrets.GIT_AUTH_TOKEN }}
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} << EOF

            set -e

            echo ">>> Ensure required packages"
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl gnupg lsb-release unzip git

            echo ">>> Install Docker if missing"
            if ! command -v docker >/dev/null 2>&1; then
              echo ">>> Installing Docker from Ubuntu repositories"
              sudo apt-get install -y docker.io docker-compose
              sudo usermod -aG docker \$USER
              sudo systemctl start docker
              sudo systemctl enable docker
            fi

            echo ">>> Install Docker Compose if missing"
            if ! docker compose version >/dev/null 2>&1 && ! command -v docker-compose >/dev/null 2>&1; then
              echo ">>> Installing legacy docker-compose"
              sudo apt-get install -y docker-compose
            fi

            echo ">>> Clean old code"
            sudo rm -rf ~/AqeedAI ~/demo

            echo ">>> Clone latest code from GitHub (main)"
            git clone --single-branch --branch main \
              https://x-access-token:${{ secrets.GIT_AUTH_TOKEN }}@github.com/AllyInAi/AqeedAI.git \
              ~/AqeedAI

            echo ">>> Listing contents of ~/AqeedAI:"
            ls -al ~/AqeedAI

            echo ">>> Copy AqeedAI folder"
            # cp -r ~/AqeedAI ~/AqeedAI

            echo ">>> Create .env"
            echo "${{ secrets.ENV_FILE }}" > ~/AqeedAI/.env

            echo ">>> Stop old containers and free up ports"
            cd ~/AqeedAI
            
            # Stop any containers using the same names
            docker stop nginx-proxy fastapi-backend frontend-app qdrant infrascope-frontend-app|| true
            docker rm nginx-proxy fastapi-backend frontend-app qdrant infrascope-frontend-app || true
            
            # Stop any containers using port 80
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -aq --filter "publish=80" | xargs -r docker rm || true
            
            # Stop services that might be using port 80
            sudo systemctl stop apache2 || true
            sudo systemctl stop nginx || true
            sudo pkill -f nginx || true
            sudo pkill -f apache2 || true
            
            # Stop compose services
            if docker compose version >/dev/null 2>&1; then
              docker compose -f docker-compose-gcp.yaml down || true
            else
              docker-compose -f docker-compose-gcp.yaml down || true
            fi

            echo ">>> Clean up Docker disk space"
            docker system prune -a -f || true

            echo ">>> Build & start new containers"
            if docker compose version >/dev/null 2>&1; then
              docker compose -f docker-compose-gcp.yaml up -d --build
            else
              docker-compose -f docker-compose-gcp.yaml up -d --build
            fi

            echo ">>> Set up SSL certificate (if not already done)"
            if [ ! -f /etc/letsencrypt/live/app-gcp.allyin.cloud/fullchain.pem ]; then
              echo ">>> Running SSL setup..."
              chmod +x setup-ssl-gcp.sh
              ./setup-ssl-gcp.sh
              echo ">>> Restarting containers with SSL..."
              if docker compose version >/dev/null 2>&1; then
                docker compose -f docker-compose-gcp.yaml down
                docker compose -f docker-compose-gcp.yaml up -d --build
              else
                docker-compose -f docker-compose-gcp.yaml down
                docker-compose -f docker-compose-gcp.yaml up -d --build
              fi
            else
              echo ">>> SSL certificate already exists, skipping setup"
            fi

            echo ">>> Test Nginx configuration"
            sleep 5
            docker logs nginx-proxy

            echo ">>> Test application access"
            curl -I https://app-gcp.allyin.cloud || echo "HTTPS not responding"
            curl -I http://localhost || echo "Local HTTP not responding"

            echo ">>> Done!"
          EOF
