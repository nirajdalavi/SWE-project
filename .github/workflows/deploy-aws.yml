name: Deploy to EC2

on:
  push:
    branches:
      - main
    # paths:
    #   - './**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (for GitHub context)
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy on EC2
        env:
          GIT_AUTH_TOKEN: ${{ secrets.GIT_AUTH_TOKEN }}
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF

            set -e

            echo ">>> Ensure required packages"
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl gnupg lsb-release unzip git

            echo ">>> Install Docker if missing"
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io
              sudo usermod -aG docker \$USER
            fi

            echo ">>> Install Docker Compose v2 plugin if missing"
            if ! docker compose version >/dev/null 2>&1; then
              echo ">>> Adding Docker APT repository"
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo \
                "deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            echo ">>> Clean old code"
            sudo rm -rf ~/AqeedAI ~/demo

            echo ">>> Clone latest code from GitHub (main)"
            git clone --single-branch --branch main \
              https://x-access-token:${{ secrets.GIT_AUTH_TOKEN }}@github.com/AllyInAi/AqeedAI.git \
              ~/AqeedAI

            echo ">>> Listing contents of ~/AqeedAI:"
            ls -al ~/AqeedAI

            echo ">>> Copy AqeedAI folder"
            # cp -r ~/AqeedAI ~/AqeedAI

            echo ">>> Create .env"
            echo "${{ secrets.ENV_FILE }}" > ~/AqeedAI/.env

            echo ">>> Stop old containers and free up ports"
            cd ~/AqeedAI
            
            # Stop any containers using the same names
            docker stop nginx-proxy fastapi-backend frontend-app qdrant infrascope-frontend-app|| true
            docker rm nginx-proxy fastapi-backend frontend-app qdrant infrascope-frontend-app || true
            
            # Stop any containers using port 80
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -aq --filter "publish=80" | xargs -r docker rm || true
            
            # Stop services that might be using port 80
            sudo systemctl stop apache2 || true
            sudo systemctl stop nginx || true
            sudo pkill -f nginx || true
            sudo pkill -f apache2 || true
            
            # Stop compose services
            docker compose -f docker-compose-aws.yaml down || true

            echo ">>> Clean up Docker disk space"
            docker system prune -a -f || true

            echo ">>> Build & start new containers"
            docker compose -f docker-compose-aws.yaml up -d --build

            echo ">>> SSL setup temporarily disabled - using HTTP only"

            echo ">>> Test Nginx configuration"
            sleep 5
            docker logs nginx-proxy

            echo ">>> Test application access"
            curl -I http://app-aws.allyin.cloud || echo "HTTP not responding"
            curl -I http://localhost || echo "Local HTTP not responding"

            echo ">>> Done!"
          EOF
